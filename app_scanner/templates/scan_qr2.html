{% extends "base.html" %}
{% block body_block %}

<div class="container text-center">
    <h4 class="text-uppercase mt-3 mb-3">Scannhing the qr code</h4>
    <div style="display: flex;justify-content: center;">
        <div id="reader" style="width: 300px;"></div>
    </div>
    <button id="switch-camera" class="btn btn-dark m-3">Switch Camera</button><br>
    <a id="retry" class="btn btn-dark m-3 mt-0" hidden href="">Retry</a>
    <p>Scanned Result: <span id="result"></span></p>
</div>

<script>
    $(document).ready(function(){
        $('#scan').addClass('active fw-bold');
    })
    $(document).ready(function () {
        let currentCameraId = null;
        let cameraList = [];
        let currentCameraIndex = 0;

        const html5QrCode = new Html5Qrcode("reader");

        // Scan success handler
        function onScanSuccess(decodedText, decodedResult) {
            // $('#result').text(decodedText);
            // console.log(`Scanned code: ${decodedText}`, decodedResult);

            $.ajax({
                url: "{% url 'check_qr_valid' %}",
                type:"POST",
                data:{
                    'qr_code':decodedText,
                    csrfmiddlewaretoken:"{{ csrf_token }}"
                },
                success:function(res){
                    alert(res.success)
                },
                error:function(error){
                    alert(error.errors)
                }
            })

            $('#switch-camera').attr('hidden',true)
            $('#retry').attr('hidden',false)

            // Optional: stop scanning after first scan
            html5QrCode.stop().then(() => {
                console.log("Scanner stopped.");
            }).catch(err => {
                console.error("Failed to stop scanner: ", err);
            });
        }

        // Start camera by index
        function startCameraByIndex(index) {
            currentCameraId = cameraList[index].id;
            html5QrCode.start(
                currentCameraId,
                {
                    fps: 10,
                    qrbox: 250
                },
                onScanSuccess
            ).catch(err => {
                console.error("Unable to start scanning: ", err);
            });
        }

        // Get available cameras and start with back one if mobile
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                cameraList = devices;

                // Try to pick the back camera by label
                const backCamIndex = devices.findIndex(cam => cam.label.toLowerCase().includes("back"));
                currentCameraIndex = backCamIndex !== -1 ? backCamIndex : 0;

                startCameraByIndex(currentCameraIndex);
            }
        }).catch(err => {
            console.error("Camera access error: ", err);
        });

        // Switch camera on button click
        $('#switch-camera').on('click', function () {
            html5QrCode.stop().then(() => {
                currentCameraIndex = (currentCameraIndex + 1) % cameraList.length;
                startCameraByIndex(currentCameraIndex);
            }).catch(err => {
                console.error("Error switching camera: ", err);
            });
        });
    });
</script>

{% endblock %}
